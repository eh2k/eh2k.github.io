<!doctype html>
<html lang="en" data-bs-theme="dark">
<style>
  :root,
  [data-bs-theme=dark] {
    color-scheme: dark;
    --bs-body-color: #c9d1d9;
    --bs-body-bg: #212529;
  }
</style>

<head>
  <base href="https://ehx.spdns.org/eh2k_github_io/">
  <meta charset="utf-8">
  <!-- Meta tags -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
  <meta name="viewport" content="width=device-width" />

  <link href="https://cdn.jsdelivr.net/npm/halfmoon@1.1.1/css/halfmoon-variables.min.css" rel="stylesheet" />

  <script src="./webmidi.iife.v3.1.8.js"></script>

</head>

<body class="dark-mode with-custom-webkit-scrollbars with-custom-css-scrollbars" data-dm-shortcut-enabled="true"
  data-sidebar-shortcut-enabled="true" data-set-preferred-mode-onload="true">


  <div class="page-wrapper with-navbar" data-sidebar-type="overlayed-sm-and-down">

    <div class="sticky-alerts"></div>
    <!-- Navbar -->
    <nav class="navbar">
      <!-- <div class="navbar-content">
        <button class="btn btn-action" type="button">
          <i class="fa fa-bars" aria-hidden="true"></i>
          <span class="sr-only">Toggle sidebar</span> 
        </button>
      </div> -->
      <a href="#" class="navbar-brand">
        <p>□● Remote</p>

      </a>
    </nav>

  </div>

  <!-- <nav class="navbar navbar-dark bg-dark">
    <a class="navbar-brand" href="#">Home</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
  </nav> -->


  <div class="content-wrapper">
    <div class="container">

      <div class="card bg-transparent">
        <div class="col">
          <canvas id="display" width="128" style="width:39%" height="64" style="border:1px solid black;"></canvas>
          <textarea rows="9" style="width:60%" id="log"></textarea>
          <br />
          <progress id="progressBar" style="display: flex; width:auto;" max="100" value="0">0%</progress>
        </div>
        <div class="col" id="remote">
          <br />
        </div>
      </div>

      <div class="card" id="midi">
        <h3>:USB MIDI TEST</h3>
        MIDI CH: <input class="form-control" type="number" min="1" max="16" value="1" class="slider"
          id="midi_channel"><br />
        PROGRAM: <input class="form-range" type="range" min="0" max="127" value="23" class="slider" id="PROGRAM"><br />
        NOTE: <div id="PIANO" class="btn-group" role="group" aria-label="Basic outlined example"></div><br />
        PITCH-BEND: <input class="form-range" type="range" min="-1" max="1" value="0" step="0.01" class="slider"
          id="PITCH"><br />
        CC32: <input class="form-range" type="range" min="0" max="127" value="64" class="slider" id="CC32"><br />
        CC33: <input class="form-range" type="range" min="0" max="127" value="64" class="slider" id="CC33"><br />
        CC34: <input class="form-range" type="range" min="0" max="127" value="64" class="slider" id="CC34"><br />
        CC35: <input class="form-range" type="range" min="0" max="127" value="64" class="slider" id="CC35"><br />
        Volume: <input class="form-range" type="range" min="0" max="127" value="64" class="slider" id="volume"><br />
      </div>
      <br />
      <divc lass="card mx-0">
        <td>
        </td>
    </div>
  </div>
  </div>

  <!-- <script src="wasm_go/pkg/wasm_exec.js"></script>
  <script>
    const go = new window.Go();

    WebAssembly.instantiateStreaming(
      fetch("wasm_go/pkg/main.wasm"),
      go.importObject
    ).then(
      (obj) => {
        go.run(obj.instance);
      }
    );

  </script> -->
  <script type="module">

    import init, {
      init_rs,
      draw_screen,
      crc32_from_uint8buffer,
      qpsk_encode
    } from "./wasm_rs/pkg/main.js";

    await init()

    init_rs();

    import {
      remoteInit,
      remoteSend,
      remoteReboot,
      remoteFirmwareVersion,
      remoteFirmwareVersion2,
      formatSD,
      sendFLASHDATA,
      fileOpen,
      remoteDisplay,
      remoteMidiOut
    } from "./remote.js?8";

    const canvas = document.getElementById("display")
    const context2d = canvas.getContext("2d")

    const n = 2
    canvas.width *= n
    canvas.height *= n
    context2d.scale(n, n)
    let offset = 0

    var idd = ""

    try {
      idd = await remoteInit(document.getElementById("log"))
      const screen = await remoteDisplay();
      draw_screen(screen, context2d);
    }
    catch (err) {
      console.error(err)
    }

    var prog = 0;

    function progress(value, max, info) {
      let element = document.getElementById('progressBar')
      element.value = value;
      element.max = max;
      element.hidden = !(value < max)

      if (info)
        document.getElementById("log").innerHTML = info
    }

    function delay(time) {
      return new Promise(resolve => setTimeout(resolve, time));
    }

    async function sendQPSK(fileBuffer) {

      if (window.transferSource) {
        window.transferSource.stop();
        window.transferSource = null;
        return;
        //document.getElementById('playStopButton').innerHTML = 'Play';
      } else {
        //this.playEncodedData();
        //document.getElementById('playStopButton').innerHTML = 'Stop';
      }

      if (fileBuffer instanceof ArrayBuffer)
        fileBuffer = Array.from(new Uint8Array(fileBuffer.slice(0, fileBuffer.length)))

      const qpsk_wav = qpsk_encode(fileBuffer);
      console.log("qpsk", qpsk_wav)

      const sampleRate = 48000;
      ////
      let context = new (window.AudioContext || window.webkitAudioContext)(
        { sampleRate: sampleRate });

      let audioBuffer = context.createBuffer(
        1, qpsk_wav.length, sampleRate);
      audioBuffer.getChannelData(0).set(qpsk_wav);

      const gain = context.createGain();
      const transferSource = context.createBufferSource();
      transferSource.buffer = audioBuffer;
      transferSource.connect(gain);
      gain.connect(context.destination);
      transferSource.start();
      window.transferSource = transferSource;

      let progressBar = document.getElementById('progressBar');
      while (true) {
        let progress = transferSource.context.currentTime / transferSource.buffer.duration * 100;
        if (progress <= 100) {
          progressBar.value = progress;
          progressBar.innerHTML = progress.toFixed(1) + '%';
          progressBar.style.visibility = 'visible';

        } else {
          progressBar.style.visibility = 'hidden';
          window.transferSource.stop();
          window.transferSource = null;
          return;
        }
        await delay(100);
      }
    }

    function AddCommand(header, cmd) {
      if (cmd != null) {
        const button = document.createElement("button")
        button.id = header
        button.className = "btn btn-outline-light"
        button.style.margin = "2px"
        button.innerText = header;
        button.onclick = async () => {
          await remoteSend(cmd);
          const screen = await remoteDisplay();
          draw_screen(screen, context2d);
        }
        document.getElementById("remote").lastChild.appendChild(button)
        return button;
      }
      else if (header != "") {
        const h4 = document.createElement("h4")
        h4.innerText = header
        document.getElementById("remote").appendChild(document.createElement("br"))
        document.getElementById("remote").appendChild(document.createElement("br"))
        document.getElementById("remote").appendChild(h4)
        document.getElementById("remote").appendChild(document.createElement("br"))

      }
      else {
        const div = document.createElement("div")
        document.getElementById("remote").appendChild(div)
      }
    }

    await remoteSend("l");
    await remoteSend("r");

    AddCommand("")
    AddCommand("MENU", "L")
    AddCommand("IO", "R")
    AddCommand("MIDI", "I")
    AddCommand("L", "l")
    AddCommand("R", "r")
    AddCommand("")
    AddCommand("LE-", "j")
    AddCommand("LE+", "J")
    AddCommand("RE-", "k")
    AddCommand("RE+", "K")
    AddCommand("")
    AddCommand("LB", "y")
    AddCommand("LH", "Y")
    AddCommand("RB", "z")
    AddCommand("RR", "Z")
    AddCommand("")
    AddCommand("")
    AddCommand("Save", "S")
    AddCommand("Debug", "d")
    AddCommand("ScreenSaver", "b")
    AddCommand("Reset", String.fromCharCode(127))
    AddCommand("")

    AddCommand(":Setup Commands")
    AddCommand("")
    AddCommand("ENTER CALIBRATION", '0')
    AddCommand("")
    AddCommand("FLIP_180", 'F')
    AddCommand("DISP_BRIGHTNESS", 'B')
    AddCommand("")
    AddCommand("DAC_8564/DAC_8565", 'D')
    AddCommand("")
    AddCommand("SH1106/SSD1306", '2')
    AddCommand("DISPLAY_SPI/SPI1", '1')

    AddCommand(":Engines")
    AddCommand("")

    AddCommand("FORMAT SD", "").onclick = async () => {
      await formatSD();
      await remoteReboot();
    }


    AddCommand("TR707", "").onclick = async () => {
      const ic34 = await fetch("roms/IC34_TR707_SNDROM.bin")
      await sendFLASHDATA("707_IC34", await ic34.arrayBuffer(), progress);
      const ic35 = await fetch("roms/IC35_TR707_SNDROM.bin")
      await sendFLASHDATA("707_IC35", await ic35.arrayBuffer(), progress);
      await remoteReboot();
    }

    AddCommand("TR909", "").onclick = async () => {
      const high = await fetch("roms/909_HiHats.bin")
      await sendFLASHDATA("909_HIGH", await high.arrayBuffer(), progress);
      const ride = await fetch("roms/909_Ride.bin")
      await sendFLASHDATA("909_RIDE", await ride.arrayBuffer(), progress);
      await remoteReboot();
    }

    AddCommand("DXFM", "").onclick = async () => {

      await fileOpen(".syx,.sysex", async syx => {
        console.log(syx)
        const data = Array.from(new Uint8Array(syx.slice(6, 6 + 4096)))
        await sendFLASHDATA("DXFMSYX0", data, progress);
        await remoteReboot();
      })
    }

    AddCommand("BIN", "").onclick = async () => {

      const loaded = await fileOpen(".bin", async (data, name) => {
        const blob = name.split(".")[0].padEnd(8, '_').substring(0, 8)
        console.log(blob, name.length, data)
        await sendFLASHDATA(blob, data, progress);
      }, true)

      if (loaded)
        await remoteReboot();
    }

    AddCommand(":USB MIDI")
    AddCommand("")

    const MIDI_TEST_PCH = "RANDOM PROG CHANGES"
    AddCommand(MIDI_TEST_PCH, "").onclick = async () => {

      let i = 0;
      let c = 0

      let seed = 1;
      function random() {
        let hi, lo, x;

        // the algorithm used in avr-libc 1.6.4
        x = seed;
        if (x == 0)
          x = 123459876;
        hi = x / 127773;
        lo = x % 127773;
        x = 16807 * lo - 2836 * hi;
        if (x < 0)
          x += 0x7FFFFFFF;
        seed = x;
        return Math.floor(x);
      }

      if (i > 0) {
        i = 0;
        return
      }

      seed = 1;
      i = 1;
      c = 1

      remoteSend("M")

      const sc_midiout = remoteMidiOut();

      await sc_midiout.channels[1].sendProgramChange(0);
      await sc_midiout.channels[2].sendProgramChange(0);
      await sc_midiout.channels[3].sendProgramChange(0);
      await sc_midiout.channels[4].sendProgramChange(0);

      let test = async () => {
        let cc = random() % 44

        if (i % 100 == 0)
          await remoteSend('r')

        await delay(1)

        if (cc == -1) {
          await test();
        } else {

          const log = "" + i + " " + " " + c + " -> " + cc + "\n"
          document.getElementById(MIDI_TEST_PCH).innerHTML = log

          await sc_midiout.channels[c].sendProgramChange(cc);

          await sc_midiout.channels[c].sendControlChange(0x7, random() % 127);
          await sc_midiout.channels[c].sendControlChange(32, random() % 127);
          await sc_midiout.channels[c].sendControlChange(33, random() % 127);
          await sc_midiout.channels[c].sendControlChange(34, random() % 127);
          await sc_midiout.channels[c].sendControlChange(35, random() % 127);
          await sc_midiout.channels[c].sendControlChange(36, random() % 127);
          await sc_midiout.channels[c].sendControlChange(37, random() % 127);

          if (c++ > 4)
            c = 1
          if (i++ > 0)
            await test(); //sc_midiout.sendSongSelect(0);
          else
            document.getElementById(MIDI_TEST_PCH).innerHTML = MIDI_TEST_PCH
        }
      }

      test();
    }

    let keys = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"]
    document.getElementById("PIANO").innerHTML = null

    function midiChannel() {
      const midi_ch = document.getElementById("midi_channel").value;
      console.log(midi_ch);
      return remoteMidiOut().channels[midi_ch];
    }
    function log(text) {
      document.getElementById("log").innerHTML += `${text}\n`;
    }
    for (var i = 0; i < 12; i++) {
      const note = 60 + i;
      let e = document.createElement("button");
      e.className = "btn btn-outline-light btn-sm"
      e.onmousedown = function () {
        log(`NoteOn ${note}`);
        midiChannel().sendNoteOn(note);
      }
      e.onmouseup = function () {
        log(`NoteOff ${note}`);
        midiChannel().sendNoteOff(note);
      }
      e.innerText = keys[i];
      document.getElementById("PIANO").appendChild(e)
    }

    document.getElementById('PITCH').oninput = function () {
      midiChannel().sendPitchBend(parseFloat(this.value));
    }
    document.getElementById('PITCH').ondblclick = function () {
      this.value = "0.0";
      midiChannel().sendPitchBend(parseFloat(this.value));
    }

    document.getElementById('PROGRAM').oninput = function () {
      midiChannel().sendProgramChange(this.value);
    }

    document.getElementById('volume').oninput = function () { midiChannel().sendControlChange(0x7, this.value); }
    document.getElementById('CC32').oninput = function () { midiChannel().sendControlChange(32, this.value); }
    document.getElementById('CC33').oninput = function () { midiChannel().sendControlChange(33, this.value); }
    document.getElementById('CC34').oninput = function () { midiChannel().sendControlChange(34, this.value); }
    document.getElementById('CC35').oninput = function () { midiChannel().sendControlChange(35, this.value); }
    /**/
  </script>

  <script src="https://cdn.jsdelivr.net/npm/halfmoon@1.1.1/js/halfmoon.min.js"></script>

</body>

</html>